#!/bin/ash
# shellcheck shell=dash disable=1091
#Import formating
. formatlib
. configlib

#download the necesary files
get-configuration &
get-schedule      &
get-songs         &
#Check if post-processing is enabled
#Wait to finish getting the configuration
wait "$(pidof get-configuration)"
if getvalue post-processing; then
    #Wait for the all the songs to be downloaded
    wait "$(pidof get-songs)"
    #run the post-processor
    post-processor
fi
#Check if a critical error has happened, if so send a email about it
if grep -q -- 'CRITICAL_ERROR' "$MUSICBOX_LOG_DIR/$(date +%Y-%m-%d)"; then
    wait
    alert-mail
fi
scheduler