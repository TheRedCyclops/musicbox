#!/bin/bash
# shellcheck shell=bash disable=1091

# Copyright The Red Cyclops Â© 2023
# This program is free software: you can redistribute it and/or modify it under the terms of
# the GNU General Public License as published by the Free Software Foundation,
# either version 3 of the License, or (at your option) any later version.
# This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
# without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU General Public License for more details.
# You should have received a copy of the GNU General Public License along with this program.
# If not, see <https://www.gnu.org/licenses/>.

# Get the path of the instalation directory [WORKING]
    installpath="$( cd -- "$(dirname "$0")" >/dev/null 2>&1 || echo "CRITICAL: failed to get the path to installation directory" ; pwd -P | sed 's/scripts\/setup//')"
# Import libraries [WORKING]
    source "$installpath/scripts/libraries/formatlib" && info "FormatLib imported"
    source "$installpath/scripts/libraries/rootpermlib" && info "RootPermLib imported"
# Check for root access [WORKING]
    if rootcheck; then
    info "Root access verified"
    else
    critical "This Script must be run as root!"
    exit 1
    fi
# Import enviroment variables [WORKING]
    source "$installpath/scripts/musicbox-env" && info "Sourced enviroment"
    # Add them to the default enviroment
    cp "$installpath/scripts/musicbox-env" /usr/lib/environment.d/musicbox.conf && info "Enviroment has been added to default"
# Create all directories [WORKING]
mkdir -p "$MUSICBOX_BIN_DIR" && info "Created $MUSICBOX_BIN_DIR Successfully"
mkdir -p "$MUSICBOX_LOG_DIR" && info "Created $MUSICBOX_LOG_DIR Successfully"
mkdir -p "$MUSICBOX_TMP_DIR" && info "Created $MUSICBOX_TMP_DIR Successfully"
mkdir -p "$MUSICBOX_CFG_DIR" && info "Created $MUSICBOX_CFG_DIR Successfully"
mkdir -p "$MUSICBOX_CACHE_DIR" && info "Created $MUSICBOX_CACHE_DIR Successfully"
# Install packages [WORKING]
    apt -y install ffmpeg mp3gain mp3val pulseaudio pulseaudio-utils vlc  mp3info unzip
        # Download and install gdrive
        # Create a temporary directory to store the download
        tmpdir=$(mktemp -d)
        # Set it so only this user can write to it
        chmod 700 "$tmpdir"
        # Download the binary
        ver=3.9.0
        wget "https://github.com/glotlabs/gdrive/releases/download/$ver/gdrive_linux-x64.tar.gz" -O "$tmpdir/gdrive-$ver.tar.gz"
        # Unpack the binary into the binaries directory
        tar xzf "$tmpdir/gdrive-$ver.tar.gz" -C "$MUSICBOX_BIN_DIR/"
        # Make the binary executable
        chmod +x "$MUSICBOX_BIN_DIR"/gdrive
        # Remove all temporary files
        rm -R "$tmpdir"
        # Download and install yt-dlp (latest)
        wget "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp" -O /usr/local/bin/yt-dlp
        chmod +x /usr/local/bin/yt-dlp
# Unpack the credentials
    echo "Getting Credentials"
    unzip "$installpath/creds.zip" -d "$installpath/creds"
# Enable cron
    systemctl enable --now cron
# Enable pulseaudio
    systemctl enable --now pulseaudio.socket
# Add unprivileged user
    adduser --home "$MUSICBOX_USER_DIR" --system --shell /bin/bash "$MUSICBOX_USER"
    # Give it access to all the needed directories
    chown "$MUSICBOX_USER" "$MUSICBOX_BIN_DIR"
    chown "$MUSICBOX_USER" "$MUSICBOX_TMP_DIR"
    chown "$MUSICBOX_USER" "$MUSICBOX_CFG_DIR"
    chown "$MUSICBOX_USER" "$MUSICBOX_LOG_DIR"
    chown "$MUSICBOX_USER" "$MUSICBOX_CACHE_DIR"
    chown "$MUSICBOX_USER" "$MUSICBOX_USER_DIR"

    # Copy drive credentials to home
    cp "$installpath/creds/gdrive_export-***REMOVED***.tar" "$MUSICBOX_USER_DIR"
    # Give permision to the user to import them
    chown "$MUSICBOX_USER" "$installpath/creds/gdrive_export-***REMOVED***.tar"
    # Setup drive access
    su -l "$MUSICBOX_USER" -s "/bin/bash" -c "$MUSICBOX_BIN_DIR/gdrive account import $MUSICBOX_USER_DIR/gdrive_export-***REMOVED***.tar"
    su -l "$MUSICBOX_USER" -s "/bin/bash" -c "$MUSICBOX_BIN_DIR/gdrive account switch ***REMOVED***"
    # Remove drive credentials from home
    rm "$MUSICBOX_USER_DIR/gdrive_export-***REMOVED***.tar"

# Setup default crontabs
    # Root Crontab
    crontab "$installpath/cron/rootcron.txt"
    # User Crontab
    crontab -u "$MUSICBOX_USER" "$installpath/cron/usercron.txt"
# Copy scripts to bin
    # Makes all scripts executable
    chmod -R +x "$installpath/scripts/"*
    # Gets all files and sends them as arguments to copy that copies them to the binaries directory
    find "$installpath/scripts" -type f -exec cp {} "$MUSICBOX_BIN_DIR/" \; && info "Copied scripts to $MUSICBOX_BIN_DIR"

# TEMPORARY FIX
# Replace all enviroment variables with hardcodes
for file in "$MUSICBOX_BIN_DIR"/*; do
# shellcheck disable=2016
sed -i -e 's/$MUSICBOX_BIN_DIR/\/usr\/lib\/musicbox/gm' "$file"
# shellcheck disable=2016
sed -i -e 's/$MUSICBOX_TMP_DIR/\/var\/tmp\/musicbox/gm' "$file"
# shellcheck disable=2016
sed -i -e 's/$MUSICBOX_LOG_DIR/\/var\/log\/musicbox/gm' "$file"
# shellcheck disable=2016
sed -i -e 's/$MUSICBOX_CFG_DIR/\/var\/etc\/musicbox/gm' "$file"
# shellcheck disable=2016
sed -i -e 's/$MUSICBOX_CACHE_DIR/\/var\/cache\/musicbox/gm' "$file"
# shellcheck disable=2016
sed -i -e 's/$MUSICBOX_USER_DIR/\/var\/local\/musicbox/gm' "$file"
# shellcheck disable=2016
sed -i -e 's/$MUSICBOX_USER/music/gm' "$file"
done
info "Instalation Finished"